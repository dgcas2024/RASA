version: "3.1"

flows:
  step_nlu_trigger_handller___intent_good__xac_nhan_chung:
    description: "Control flow với intent xác nhận chung chung"
    always_include_in_prompt: false
    nlu_trigger:
    - intent: "intent_good__xac_nhan_chung"
    steps:
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
      next:
      - if: slots.slot_latest_run_step = "step_chao_hoi_khach_hang"
        then: 
          - link: step_nhac_kh_tra_no_dung_han
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2"
        then: 
          - link: step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1"
        then: 
          - link: step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2"
        then: 
          - link: step_ghi_nhan_thong_tin_tra_no_good
      - else:
        - action: utter_xin_khach_hang_noi_lai
          next: END

  step_nlu_trigger_handller___intent_good__xac_nhan_thanh_toan:
    description: "Control flow với intent xác nhận thanh toán"
    always_include_in_prompt: false
    nlu_trigger:
    - intent: "intent_good__xac_nhan_thanh_toan"
    steps:
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
      next:
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2"
        then: 
          - link: step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1"
        then:
          - link: step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2"
        then:
          - link: step_ghi_nhan_thong_tin_tra_no_good
      - else:
        - action: utter_xin_khach_hang_noi_lai
          next: END
  
  step_nlu_trigger_handller___intent_bad__xac_nhan_chung:
    description: "Control flow với intent KHÔNG xác nhận chung chung"
    always_include_in_prompt: false
    nlu_trigger:
    - intent: "intent_bad__xac_nhan_chung"
    steps:
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
      next:
      - if: slots.slot_latest_run_step = "step_chao_hoi_khach_hang"
        then:
          - link: step_nham_so_xin_loi_khach_hang
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2"
        then:
          - link: step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1"
        then:
          - link: step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2"
        then:
          - link: step_ghi_nhan_thong_tin_tra_no_bad
      - else:
        - action: utter_xin_khach_hang_noi_lai
          next: END
  
  step_nlu_trigger_handller___intent_bad__xac_nhan_thanh_toan:
    description: "Control flow với intent KHÔNG xác nhận thanh toán"
    always_include_in_prompt: false
    nlu_trigger:
    - intent: "intent_bad__xac_nhan_thanh_toan"
    steps:
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
      next:
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2"
        then:
          - link: step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1"
        then:
          - link: step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2
      - if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2"
        then:
          - link: step_ghi_nhan_thong_tin_tra_no_bad
      - else:
        - action: utter_xin_khach_hang_noi_lai
          next: END

  step_chao_hoi_khach_hang:
    description: "Chào hỏi khách hàng"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = ""
    nlu_trigger:
    - intent: "intent_start"
    steps:
    - action: utter_xac_nhan_khach_hang
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_chao_hoi_khach_hang"

  step_nhac_kh_tra_no_dung_han:
    description: "Nhắc khách hàng trả nợ đúng hạn"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_chao_hoi_khach_hang"
    nlu_trigger:
    - intent: "intent_good__xac_nhan_danh_tinh"
    steps:
    - action: utter_nhac_kh_tra_no_dung_han
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_nhac_kh_tra_no_dung_han"
  
  step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1:
    description: "Xác nhận lần 1 khi khách hàng xác nhận trả nợ đúng hạn"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2"
    steps:
    - action: utter_phan_hoi_tra_no_dung_han_good_xac_nhan_lan_1
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_1"
  
  step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2:
    description: "Xác nhận lần 2 khi khách hàng xác nhận trả nợ đúng hạn"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han"
    steps:
    - action: utter_phan_hoi_tra_no_dung_han_good_xac_nhan_lan_2
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2"
  
  step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1:
    description: "Hỏi lý do lần 1 khi khách hàng KHÔNG xác nhận trả nợ đúng hạn"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han" or slot_latest_run_step = "utter_phan_hoi_tra_no_dung_han_good_xac_nhan_lan_1" or slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2"
    steps:
    - action: utter_phan_hoi_tra_no_dung_han_bad_hoi_ly_do_lan_1
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1"

  step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2:
    description: "Hỏi lý do lần 2 khi khách hàng KHÔNG xác nhận trả nợ đúng hạn"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_1"
    steps:
    - action: utter_phan_hoi_tra_no_dung_han_bad_hoi_ly_do_lan_2
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2"

  step_nham_so_xin_loi_khach_hang:
    description: "Liên hệ nhầm người, xin lỗi khách hàng và chào tạm biệt"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_chao_hoi_khach_hang"
    nlu_trigger:
    - intent: "intent_bad__xac_nhan_danh_tinh"
    steps:
    - action: utter_nham_so_xin_loi_vi_lam_phien
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_nham_so_xin_loi_khach_hang"
  
  step_ghi_nhan_thong_tin_tra_no_good:
    description: "Ghi nhận thông tin KH xác nhận trả nợ đúng hạn"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__good_xac_nhan_lan_2"
    steps:
    - action: utter_ghi_nhan_thong_tin_tra_no_good
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_ghi_nhan_thong_tin_tra_no_good"
  
  step_ghi_nhan_thong_tin_tra_no_bad:
    description: "Ghi nhận thông tin KH xác nhận KHÔNG trả nợ đúng hạn"
    always_include_in_prompt: true
    if: slots.slot_latest_run_step = "step_nhac_kh_tra_no_dung_han__bad_hoi_ly_do_lan_2"
    steps:
    - action: utter_ghi_nhan_thong_tin_tra_no_bad
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_ghi_nhan_thong_tin_tra_no_bad"
  
  step_force_end:
    description: "Flow force end"
    always_include_in_prompt: true
    nlu_trigger:
    - intent: "intent_force_end"
    steps:
    - action: utter_force_end
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - set_slots:
      - slot_latest_run_step: "step_force_end"
  
  step_nlu_fallback:
    description: "Flow fallback"
    always_include_in_prompt: true
    nlu_trigger:
    - intent: "nlu_fallback"
    steps:
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - action: utter_xin_khach_hang_noi_lai
    #- set_slots:
    #  - slot_latest_run_step: "step_nlu_fallback"
  
  step_faq1:
    description: "FAQ1"
    always_include_in_prompt: true
    nlu_trigger:
    - intent: "intent_faq1"
    steps:
    - collect: slot_latest_run_step
      ask_before_filling: false
      reset_after_flow_ends: false
    - action: utter_faq1